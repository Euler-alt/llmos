# LLM OS 新式后端使用指南

## 概述

这个新式后端系统提供了动态窗口配置管理功能，允许后端控制前端显示的窗口类型、顺序和配置。

## 文件结构

```
LLMOS/
├── NewVirtualEnd.py          # 新式后端服务器
├── start_new_backend.py      # 启动脚本
├── VirtualEnd.py             # 旧版后端（兼容）
└── llmos-whiteboard/
    └── src/
        ├── App.js                    # 修正后的前端
        └── components/
            ├── ComponentRegistry.js # 修正后的验证逻辑
            └── DynamicWindowFactory.js # 动态窗口工厂
```

## 启动方法

### 方法1：使用启动脚本（推荐）
```bash
python start_new_backend.py
```

### 方法2：直接运行后端
```bash
python NewVirtualEnd.py
```

## API 接口

### 1. SSE 实时数据流
- **端点**: `GET /api/sse`
- **功能**: 实时推送窗口配置和模块数据
- **数据格式**:
```json
{
  "windows": [
    {
      "id": "kernel-1",
      "type": "kernel",
      "title": "内核窗口",
      "order": 0
    }
  ],
  "kernel": "内核数据...",
  "heap": "堆数据..."
}
```

### 2. 窗口配置管理
- **获取配置**: `GET /api/windows/config`
- **更新配置**: `POST /api/windows/config`
- **请求体**:
```json
{
  "windows": [
    {
      "id": "custom-1",
      "type": "kernel",
      "title": "自定义内核",
      "order": 0
    }
  ]
}
```

### 3. 传统兼容接口
- **获取模块**: `GET /api/modules`（向后兼容）
- **更新模块**: `POST /api/modules/update`（向后兼容）
- **LLM调用**: `POST /api/llm/call`

## 前端配置

### 支持的窗口类型
- `kernel` - 内核窗口（系统规则和工作流程）
- `heap` - 堆窗口（持久化存储区域）
- `stack` - 栈模块（临时工作区域）
- `code` - 代码窗口（代码编辑和执行区域）

### 自定义窗口配置示例

后端可以动态配置前端显示的窗口：

```python
# 在 NewVirtualEnd.py 中修改 window_configs
self.window_configs = [
    WindowConfig(
        id="custom-kernel",
        type="kernel",
        title="智能内核",
        description="AI驱动的规则引擎",
        order=0,
        color="purple",
        icon="ai"
    ),
    WindowConfig(
        id="memory-manager", 
        type="heap",
        title="内存管理器",
        description="智能内存分配",
        order=1
    )
    # 可以只显示部分窗口，或调整顺序
]
```

## 数据流说明

### 新式数据流
1. 前端连接 SSE (`/api/sse`)
2. 后端推送完整状态（窗口配置 + 模块数据）
3. 前端根据配置动态渲染窗口
4. 用户操作触发数据更新
5. 后端广播给所有连接的客户端

### 与传统后端的区别

| 特性 | 传统后端 | 新式后端 |
|------|----------|----------|
| 窗口配置 | 前端固定 | 后端动态控制 |
| 数据格式 | 简单字典 | 结构化配置 |
| 扩展性 | 有限 | 高度可扩展 |
| 多客户端同步 | 基础同步 | 实时广播 |

## 开发指南

### 添加新的窗口类型

1. **前端注册**（ComponentRegistry.js）:
```javascript
registerComponent('new-type', NewComponent, {
  title: '新组件',
  description: '新组件描述',
  color: 'orange'
});
```

2. **后端支持**（NewVirtualEnd.py）:
```python
# 在 validate_window_type 中添加新类型
valid_types = {"kernel", "heap", "stack", "code", "new-type"}
```

### 自定义数据格式

后端可以扩展模块数据格式：
```python
self.module_data = {
    "kernel": {
        "rules": ["规则1", "规则2"],
        "workflow": "工作流描述",
        "metadata": {"version": "1.0"}
    },
    "heap": {
        "storage": "数据内容",
        "format": "json"
    }
}
```

## 故障排除

### 常见问题

1. **SSE 连接失败**
   - 检查后端是否运行在端口 3001
   - 查看浏览器控制台错误信息

2. **窗口显示异常**
   - 确认窗口类型在前端注册表中存在
   - 检查后端配置的 type 字段是否正确

3. **数据不同步**
   - 确认后端调用了 `broadcast_update()`
   - 检查 SSE 客户端连接状态

### 调试技巧

- 访问 `http://localhost:3001/docs` 查看 API 文档
- 查看后端控制台输出了解数据处理流程
- 使用浏览器开发者工具监控 SSE 数据流

## 迁移说明

从传统后端迁移到新式后端：

1. **数据格式更新**: 后端需要发送包含 `windows` 数组的完整状态
2. **验证逻辑**: 前端已更新验证逻辑支持新旧格式
3. **API兼容**: 传统接口保持兼容，可以逐步迁移

## 性能优化建议

- 对于大量数据，考虑分页加载
- 使用 WebSocket 替代 SSE 如需双向通信
- 实现数据压缩减少网络传输
- 添加缓存机制提升响应速度

这个新式后端系统为 LLM OS 提供了更强大的动态配置能力，支持复杂的多窗口协作场景。